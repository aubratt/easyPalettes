{% extends "auctions/layout.html" %}

{% block body %}
    <div class="row">
        <div class="col-8 d-flex justify-content-center">
            {% if listing.image %}
                <img class="card-img-top" style="align-items: center; max-width: 100%; max-height: 500px; height: auto; width: auto; object-fit: contain;" src="{{ listing.image }}" alt="Product Image">
            {% else %}
                <img style="align-items: center; max-width: 100%; max-height: 500px; height: auto; width: auto; object-fit: contain;" src="https://static.vecteezy.com/system/resources/previews/022/014/063/original/missing-picture-page-for-website-design-or-mobile-app-design-no-image-available-icon-vector.jpg" alt="Default Image">
            {% endif %}
        </div>
        <div class="col-4">
            {% if not listing.is_active %}
                <h3 style="color: red;">CLOSED</h3>
            {% endif %}

            <h2>{{ listing.title }}</h2>
            <p>Seller: {{ listing.user }}</p>
            {% if listing.category == "Choose (optional)..." %}
                
            {% else %}
                <p>Category: <a href="{% url 'category' listing.category %}" style="text-decoration: none;">{{ listing.category|title }}</a></p>
            {% endif %}           
            <p>Description: {{ listing.description }}</p>

            {% if listing.is_active %}
                <p>Current Price: ${{ current_price }}</p>
            {% endif %}

            {% if user.is_authenticated %}
                {% if listing.is_active %}
                    <p>Leading bid: {{ leading_bid }}</p>
                    <p>Leading bid user: {{ leading_bid.user }}</p>
                    <p>Request user: {{ request.user }}</p>
                    {% if request.user == listing.user %}
                        <form method="POST" action="{% url 'close' listing.slug %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="close">
                            <button type="submit" class="btn btn-primary mb-3">End Auction</button>
                        </form>
                    {% else %}
                        <form method="POST" action="{% url 'bid' listing.slug %}">
                            {% csrf_token %}
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">$</span>
                                </div>
                                <input type="text" name="bid" class="form-control mr-1" placeholder="Bid (e.g. 50.00)">
                                <button type="submit" name="action" value="place_bid" class="btn btn-primary">Place Bid</button>
                            </div>
                            <p>{{ error }}</p>
                        </form>
                        
                        <form method="POST" action="{% url 'add' listing.slug %}">
                            {% csrf_token %}

                            {% if watching %}
                                <button type="submit" name="action" value="remove" class="btn btn-outline-danger">Remove from Watchlist</button>
                            {% else %}
                                <button type="submit" name="action" value="add" class="btn btn-secondary">Add to Watchlist</button>
                            {% endif %}
                            <p>{{ message }}</p>
                        </form>
                    {% endif %}
                {% else %}
                    <p>Leading bid: {{ leading_bid }}</p>
                    <p>Leading bid user: {{ leading_bid.user }}</p>
                    <p>Request user: {{ request.user }}</p>
                        
                    {% if request.user == leading_bid.user %}
                        <p style="color: green;"><strong>You won this auction with a bid of ${{ current_price }}.</strong></p>
                    {% else %}
                        <p><strong>Sold for ${{ current_price }}.</strong></p>
                    {% endif %}
                {% endif %}
            {% else %}
                <p><strong>Log in to bid on this item or add it to your watchlist.</strong></p>
            {% endif %}

            <p>Created {{ listing.time }}</p>

            <h4>Comments</h4>
            
            <form method="POST" action="{% url 'comment' listing.slug %}">
                {% csrf_token %}
                <div class="d-flex">
                    <p class="mr-2" style="color: gray;"><strong>{{ request.user|truncatechars:10 }}</strong></p>
                    <textarea class="w-100 mb-2" placeholder="Add comment"></textarea>
                </div>
                <div class="d-flex justify-content-end" style="width: 100%;">
                    <button class="btn btn-dark">Post</button>
                </div>
            </form>

            {% for comment in comments %}
                {% if comment.user == listing.user %}
                    <p class="mb-1" style="color: green"><strong>{{ comment.user }} (Seller)</strong></p>
                {% else %}
                    <p class="mb-1"><strong>{{ comment.user }}</strong></p>
                {% endif %}
                <p class="mb-1">{{ comment.content }}</p>
                <p style="color: gray"><small>{{ comment.time }}</small></p>
            {% endfor %}

        </div>
    </div>
{% endblock %}